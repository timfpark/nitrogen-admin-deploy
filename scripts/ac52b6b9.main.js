!function(){window.App=Ember.Application.create({LOG_TRANSITIONS:!0})}(),function(){App.ApplicationController=Ember.Controller.extend({actions:{signout:function(){App.session.service.clearCredentials(App.user),this.transitionToRoute("user.login"),App.set("session",null)}}})}(),function(){App.UserLoginController=Ember.Controller.extend({mode:"signin",createMode:function(){return"create"===this.get("mode")}.property("mode"),resetPasswordMode:function(){return"reset"===this.get("mode")}.property("mode"),notResetPasswordMode:function(){return!this.get("resetPasswordMode")}.property("resetPasswordMode"),signInMode:function(){return"signin"===this.get("mode")}.property("mode"),modeTitle:function(){var a=this.get("mode");return"create"===a?"CREATE ACCOUNT":"signin"===a?"SIGN IN":"reset"===a?"RESET PASSWORD":void 0}.property("mode"),actions:{create:function(){var a=new nitrogen.User({name:this.get("name"),email:this.get("email"),password:this.get("password"),nickname:"current"});App.service.create(a,App.sessionHandler)},login:function(){var a=new nitrogen.User({email:this.get("email"),password:this.get("password"),nickname:"current"});App.service.authenticate(a,App.sessionHandler)},resetPassword:function(){var a=this;nitrogen.Principal.resetPassword(App.config,this.get("email"),function(b){var c;b&&(c=b.message);var d=c||"Your password has been reset.  Please check your email for login instructions.";App.set("flash",d),b||a.set("mode","signin")})},switchToCreate:function(){this.set("mode","create")},switchToResetPassword:function(){this.set("mode","reset")},switchToSignIn:function(){this.set("mode","signin")}}})}(),function(){App.UserPasswordController=Ember.Controller.extend({actions:{changePassword:function(){var a=this.get("currentPassword"),b=this.get("newPassword"),c=this.get("repeatNewPassword"),d=App.get("user.email");if(a&&0!==a.length)if(a&&0!==b.length)if(c&&b===c){var e=App.get("user");e.changePassword(App.session,a,b,function(a){if(a)return App.set("flash",a.message||"Failed to change password, please try again.");App.set("session",null);var c=new nitrogen.User({email:d,password:b,nickname:"current"});App.service.authenticate(c,App.sessionHandler)})}else App.set("flash","The new passwords you entered do not match.");else App.set("flash","Please enter a new password.");else App.set("flash","Please enter your current password.")}}})}(),function(){App.modelCache={},App.findWithAdapter=function(a,b,c,d){var e=$.Deferred();return c.find(App.session,a,b,function(a,b){if(a)return e.reject(a);var c=b.map(function(a){return d.create(a)});e.resolve(c)}),e},App.findByIdWithAdapter=function(a,b,c,d){var e=$.Deferred();d||(d=60);var f;if(App.modelCache[a]){var g=App.modelCache[a];g.expiration>Date.now()&&(f=g.model,setTimeout(function(){e.resolve(f)},0))}return f||b.findById(App.session,a,function(b,f){if(b)return e.reject(b);var g=c.create(f);App.modelCache[a]={expiration:Date.now()+1e3*d,model:g},e.resolve(g)}),e},App.saveWithDeferred=function(a){var b=$.Deferred();return a.save(App.session,function(a,c){return a?b.reject(a):(b.resolve(c),void 0)}),b},App.sendWithDeferred=function(a){var b=$.Deferred();return a.send(App.session,function(a,c){return a?b.reject(a):(b.resolve(c),void 0)}),b}}(),function(){App.Message=Ember.Object.extend(nitrogen.Message.prototype),App.Message.reopen({bodyJSON:function(){return JSON.stringify(this.get("body"))}.property("body"),bodyUrlWithAccessToken:function(){return this.get("body")&&this.get("body.url")?this.get("body.url")+"?access_token="+encodeURIComponent(App.get("session.accessToken.token")):null}.property("body.url"),createdAtString:function(){var a=new Date(Date.parse(this.get("created_at")));return a.toLocaleString()}.property("created_at"),fromPrincipal:function(){if(this.get("from")){var a=this;App.Principal.findById(this.get("from")).then(function(b){a.set("fromPrincipal",b)})}}.property("from"),fromName:function(){return this.get("fromPrincipal.name")}.property("from","fromPrincipal"),toPrincipal:function(){if(this.get("to")){var a=this;App.Principal.findById(this.get("to")).then(function(b){a.set("toPrincipal",b)})}}.property("to"),toName:function(){return this.get("toPrincipal.name")}.property("to","toPrincipal"),isCameraCommand:function(){return this.is("cameraCommand")}.property("type"),isHeartbeat:function(){return this.is("heartbeat")}.property("type"),isImage:function(){return this.is("image")}.property("type"),isLog:function(){return this.is("log")}.property("type"),isIP:function(){return this.is("ip")}.property("type"),isIPMatch:function(){return this.is("ip_match")}.property("type"),isNotHeartbeat:function(){return!this.is("heartbeat")}.property("type"),send:function(){return App.sendWithDeferred(new nitrogen.Message(this))},timestampString:function(){var a=new Date(Date.parse(this.get("ts"))),b=Math.floor(this.get("ts").getMilliseconds()/10);return 10>b&&(b="0"+b),a.toLocaleString(navigator.language,{hour12:!1})+"."+b}.property("ts")}),App.Message.reopenClass({find:function(a,b){return App.findWithAdapter(a,b,nitrogen.Message,App.Message)}})}(),function(){App.Permission=Ember.Object.extend(nitrogen.Permission.prototype),App.Permission.reopen({issuedToPrincipal:function(){if(this.get("issued_to")){var a=this;App.Principal.findById(this.get("issued_to")).then(function(b){a.set("issuedToPrincipal",b)})}}.property("issued_to"),issuedToName:function(){return this.get("issuedToPrincipal.name")}.property("issued_to","issuedToPrincipal"),principalForPrincipal:function(){if(this.get("principal_for")){var a=this;App.Principal.findById(this.get("principal_for")).then(function(b){a.set("principalForPrincipal",b)})}}.property("principal_for"),principalForName:function(){return this.get("principalForPrincipal.name")}.property("principal_for","principalForPrincipal"),actionString:function(){return this.get("action")?this.get("action"):"all"}.property("action"),expiresString:function(){return this.get("expires")?this.get("expires"):"never"}.property("expires")}),App.Permission.reopenClass({find:function(a,b){return App.findWithAdapter(a,b,nitrogen.Permission,App.Permission)}})}(),function(){App.Principal=Ember.Object.extend(nitrogen.Principal.prototype),App.Principal.reopen({hasTag:function(a){return-1!==this.get("tags").indexOf(a)},hasCamera:function(){return this.hasTag("executes:cameraCommand")}.property("tags"),hasSwitch:function(){return this.hasTag("executes:switchCommand")}.property("tags"),isDevice:function(){return this.is("device")}.property("type"),isUser:function(){return this.is("user")}.property("type"),lastConnectionString:function(){var a=new Date(Date.parse(this.get("last_connection")));return a.toLocaleString()}.property("last_connection"),nameOrId:function(){return this.get("name")||this.get("id")}.property("id","name"),save:function(){return App.saveWithDeferred(new nitrogen.Principal(this))}}),App.Principal.reopenClass({find:function(a,b){return App.findWithAdapter(a,b,nitrogen.Principal,App.Principal)},findById:function(a){return a?App.findByIdWithAdapter(a,nitrogen.Principal,App.Principal):void 0}})}(),function(){App.AuthenticatedRoute=Ember.Route.extend({beforeModel:function(){return App.session?void 0:Ember.RSVP.reject()},actions:{error:function(){App.resetSession()},willTransition:function(){return App.set("flash",null),!0}}})}(),function(){App.AgentsRoute=App.AuthenticatedRoute.extend({model:function(){return App.Agent.find()}})}(),function(){App.MessagePagingRoute=App.AuthenticatedRoute.extend({buildPageUrl:function(a){return this.get("baseUrl")+"/skip/"+a.skip+"/sort/"+a.sort+"/direction/"+a.direction},changePage:function(a){return{skip:parseInt(this.get("params.skip"))+a*parseInt(this.get("messagePageLimit")),direction:this.get("params.direction"),sort:this.get("params.sort")}},fullPage:function(){return this.get("controller.content.length")>=this.get("messagePageLimit")}.property("controller.content.length","messagesPerPage"),hasPreviousPage:function(){return 0!==parseInt(this.get("params.skip"))}.property("params.skip"),nextPage:function(){return this.changePage(1)}.property("params.skip","params.direction","params.sort"),nextPageUrl:function(){return this.buildPageUrl(this.get("nextPage"))}.property("nextPage"),previousPage:function(){return this.changePage(-1)}.property("params.skip","params.direction","params.sort"),previousPageUrl:function(){return this.buildPageUrl(this.get("previousPage"))}.property("previousPage")})}(),function(){App.MessagesRoute=App.MessagePagingRoute.extend({messagePageLimit:50,baseUrl:"/#/messages",activate:function(){setTimeout(function(){$("#messagesTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#messagesTab").removeClass("active")},0)},model:function(a){return this.set("params",a),this.query()},query:function(){var a={};return a[this.get("params").sort]=parseInt(this.get("params").direction),App.Message.find({type:{$ne:"heartbeat"},ts:{$lt:new Date}},{skip:parseInt(this.get("params").skip),limit:parseInt(this.get("messagePageLimit")),sort:a})},serialize:function(a){return{skip:a.skip,sort:a.sort,direction:a.direction}},setupController:function(a,b){this._super(a,b);var c=this;this.subscription=App.session.onMessage(function(){c.query().then(function(a){c.controller.set("content",a)})})},actions:{willTransition:function(){if(this.subscription){var a=App.get("session");a&&a.disconnectSubscription(this.subscription),this.subscription=null}}}})}(),function(){App.PrincipalRoute=App.AuthenticatedRoute.extend({activate:function(){},deactivate:function(){setTimeout(function(){$("#usersTab").removeClass("active")},0),setTimeout(function(){$("#allTab").removeClass("active")},0),setTimeout(function(){$("#devicesTab").removeClass("active")},0)},model:function(a){return this.set("params",a),this.query()},query:function(){return App.Principal.findById(this.get("params.id"))},serialize:function(a){return{id:a.get("id")}},setupController:function(a,b){this._super(a,b),"user"===this.get("controller.content.type")?setTimeout(function(){$("#usersTab").addClass("active")},0):"device"===this.get("controller.content.type")?setTimeout(function(){$("#devicesTab").addClass("active")},0):setTimeout(function(){$("#allTab").addClass("active")},0)}})}(),function(){App.PrincipalAccountRoute=App.AuthenticatedRoute.extend({activate:function(){setTimeout(function(){$("#principalAccountTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#principalAccountTab").removeClass("active")},0)},model:function(){return this.modelFor("principal")}})}(),function(){App.PrincipalCommandsRoute=App.AuthenticatedRoute.extend({activate:function(){setTimeout(function(){$("#commandsTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#commandsTab").removeClass("active")},0)},model:function(){return this.modelFor("principal")}})}(),function(){App.PrincipalLogsRoute=App.MessagePagingRoute.extend({messagePageLimit:50,baseUrl:function(){var a="/#/principal/"+this.modelFor("principal").id+"/logs";return console.log(a),a}.property(),activate:function(){setTimeout(function(){$("#principalLogsTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#principalLogsTab").removeClass("active")},0)},filter:function(){var a=this.modelFor("principal");return{$and:[{type:"log"},{$or:[{to:a.id},{from:a.id}]}]}},model:function(a){return a.sort||(a.sort="ts"),a.skip||(a.skip=0),a.direction||(a.direction=-1),this.set("params",a),this.query(a)},query:function(a){var b={};return b[a.sort]=parseInt(a.direction),App.Message.find(this.filter(),{skip:parseInt(this.get("params").skip),limit:parseInt(this.get("messagePageLimit")),sort:b})},setupController:function(a,b){this._super(a,b),this.controller.set("router",this);var c=this;this.subscription=App.session.onMessage(this.filter(),function(){c.query(c.get("params")).then(function(a){c.controller.set("content",a)})})},actions:{willTransition:function(){if(this.subscription){var a=App.get("session");a&&a.disconnectSubscription(this.subscription),this.subscription=null}}}})}(),function(){App.PrincipalMessagesRoute=App.MessagePagingRoute.extend({messagePageLimit:25,baseUrl:function(){return"/#/principal/"+this.modelFor("principal").id+"/messages"}.property(),activate:function(){setTimeout(function(){$("#principalMessagesTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#principalMessagesTab").removeClass("active")},0)},filter:function(){var a=this.modelFor("principal");return{$and:[{type:{$ne:"heartbeat"}},{type:{$ne:"log"}}],$or:[{to:a.id},{from:a.id}]}},model:function(a){return a.sort||(a.sort="ts"),a.skip||(a.skip=0),a.direction||(a.direction=-1),this.set("params",a),this.query(a)},query:function(a){var b={};return b[a.sort]=parseInt(a.direction),App.Message.find(this.filter(),{skip:parseInt(a.skip),limit:parseInt(this.get("messagePageLimit")),sort:b})},setupController:function(a,b){this._super(a,b);var c=this;this.subscription=App.session.onMessage(this.filter(),function(){c.query(c.get("params")).then(function(a){c.isDestroyed||c.controller.set("content",a)})})},actions:{willTransition:function(){if(this.subscription){var a=App.get("session");a&&a.disconnectSubscription(this.subscription),this.subscription=null}}}})}(),function(){App.PrincipalPermissionsRoute=App.AuthenticatedRoute.extend({messagePageLimit:50,activate:function(){setTimeout(function(){$("#principalPermissionsTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#principalPermissionsTab").removeClass("active")},0)},model:function(){return this.query()},query:function(){var a=this.modelFor("principal");return App.Permission.find({$or:[{issued_to:a.id},{principal_for:a.id}]},{})},actions:{deletePermission:function(a){var b=this;a.remove(App.session,function(a){return a?App.set("flash",a.message):(b.query().then(function(a){b.controller.set("content",a)}),void 0)})}}})}(),function(){App.PrincipalsRoute=App.AuthenticatedRoute.extend({pageLimit:50,maxUpdateRate:1e4,timeoutSet:!1,nextUpdate:new Date,tabHighlight:function(){"user"===this.get("params.type")?(setTimeout(function(){$("#usersTab").addClass("active")},0),setTimeout(function(){$("#allTab").removeClass("active")},0),setTimeout(function(){$("#devicesTab").removeClass("active")},0)):"device"===this.get("params.type")?(setTimeout(function(){$("#usersTab").removeClass("active")},0),setTimeout(function(){$("#allTab").removeClass("active")},0),setTimeout(function(){$("#devicesTab").addClass("active")},0)):(setTimeout(function(){$("#usersTab").removeClass("active")},0),setTimeout(function(){$("#allTab").addClass("active")},0),setTimeout(function(){$("#devicesTab").removeClass("active")},0))}.observes("params.type"),activate:function(){"user"===this.get("params.type")?setTimeout(function(){$("#usersTab").addClass("active")},0):"device"===this.get("params.type")?setTimeout(function(){$("#devicesTab").addClass("active")},0):setTimeout(function(){$("#allTab").addClass("active")},0)},deactivate:function(){setTimeout(function(){$("#usersTab").removeClass("active")},0),setTimeout(function(){$("#allTab").removeClass("active")},0),setTimeout(function(){$("#devicesTab").removeClass("active")},0)},model:function(a){return a.sort="last_connection",a.direction=-1,a.skip=0,this.set("params",a),this.query()},query:function(){var a={};"all"!=this.get("params.type")&&(a.type=this.get("params.type"));var b={};return b[this.get("params").sort]=parseInt(this.get("params").direction),App.session?App.Principal.find(a,{skip:parseInt(this.get("params").skip),limit:parseInt(this.get("pageLimit")),sort:b}):void 0},setupController:function(a,b){this._super(a,b)},actions:{"delete":function(a){var b=this;a.remove(App.session,function(a){return a?App.set("flash",a.message):(b.query().then(function(a){b.controller.set("content",a)}),void 0)})}}})}(),function(){App.Router.map(function(){this.resource("agents"),this.resource("messages",{path:"/messages/skip/:skip/sort/:sort/direction/:direction"}),this.resource("principals",{path:"principals/:type"}),this.resource("principal",{path:"principal/:id"},function(){this.route("commands"),this.route("logs"),this.route("messages"),this.route("permissions")})}),App.IndexRoute=Ember.Route.extend({redirect:function(){this.transitionTo("principals","all")}})}(),function(){App.CameraCapabilityView=Em.View.extend({templateName:"capabilities/camera",actions:{sendSnapshot:function(){this.sendCommand("snapshot")},sendMotion:function(){this.sendCommand("motion")}},commands:function(){var a=Em.A();return this.cameraManager?(this.cameraManager.messageQueue.forEach(function(b){a.pushObject(b)}),a):Em.A([])}.property("invalidation"),invalidation:null,init:function(){this.cameraManager=new nitrogen.CameraManager(this.get("principal"));var a=this;this.cameraManager.start(App.session,function(){a.isDestroyed||a.set("invalidation",new Date)})},sendCommand:function(a){var b=this.get("principal.id"),c=new nitrogen.Message({to:b,type:"cameraCommand",tags:[nitrogen.CommandManager.commandTag(b)],body:{command:a}});c.send(App.session,function(a){a&&console.log("sending command failed: "+a)})}})}(),function(){App.SwitchCapabilityView=Em.View.extend({templateName:"capabilities/switch",actions:{sendSwitch:function(){var a=0===this.switchManager.state?1:0,b=this.get("principal.id"),c=new nitrogen.Message({to:b,type:"switchCommand",tags:[nitrogen.CommandManager.commandTag(b)],body:{on:a}});c.send(App.session,function(a){a&&console.log("sending command failed: "+a)})},sendMotion:function(){this.sendCommand("motion")}},commands:function(){var a=Em.A();return this.switchManager?(this.switchManager.messageQueue.forEach(function(b){a.pushObject(b)}),a):Em.A([])}.property("invalidation"),invalidation:null,init:function(){this.switchManager=new nitrogen.SwitchManager(this.get("principal"));var a=this;this.switchManager.start(App.session,function(){a.isDestroyed||a.set("invalidation",new Date)})}})}(),function(){App.MessagesTableView=Em.View.extend({templateName:"messages/messagesTable"})}(),function(){App.ClaimView=Em.View.extend({templateName:"principals/claim",actions:{claim:function(){var a=new nitrogen.Message({to:"service",type:"claim",body:{claim_code:this.get("claimCode").toUpperCase()}});a.send(App.session,function(a){a&&App.set("flash",a.message),window.location.reload()})}}})}(),function(){App.PrincipalView=Em.View.extend({viewing:!0,edit:function(){this.set("viewing",!1)},save:function(a){this.set("viewing",!0),this.set("principal",a.save())}})}(),function(){function a(a){var b=window.location.href.lastIndexOf("?");if(b>-1)for(var c=location.href.substr(b+1),d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(decodeURIComponent(f[0])===a){for(var g="",h=1;h<f.length;h++)1!==h&&(g+="="),g+=decodeURIComponent(f[h]);return g}}return null}function b(){var a=window.location.hash.indexOf("?"),b=window.location.hash.substr(0,a);window.history.pushState("","Nitrogen","/"+b)}App.set("config",{api_key:"admin",log_levels:["info","warn","error"]}),request.log={debug:function(){},info:function(){},error:function(){}},App.resetSession=function(){App.get("session")&&App.get("session").stop(),App.set("session",null),App.get("service").configure(App.get("user"),function(c,d){if(c)return App.resetSession(c);App.set("config",d);var e=a("principal"),f=a("accessToken");if(!e||!f){var g=d.endpoints.users+"/impersonate"+"?redirect_uri="+encodeURIComponent(document.URL)+"&api_key="+encodeURIComponent(App.get("config").api_key);return window.location.replace(g)}e=JSON.parse(e),e.accessToken=f=JSON.parse(f),b(),App.set("user",new nitrogen.User(e)),App.set("service",new nitrogen.Service(App.get("config"))),App.set("session",App.get("service").startSession(App.get("user"),f)),App.get("session").onAuthFailure(App.resetSession),App.advanceReadiness()})},App.set("service",new nitrogen.Service(App.get("config"))),App.deferReadiness(),App.resetSession()}();